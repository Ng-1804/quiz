<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site</title>
</head>

<body>

    <input type="email" name="email" id="emailLogin" placeholder="Email address" autocomplete="on"><br><br>
    <input type="password" name="password" id="passswordLogin"><br><br>
    <input type="button" value="Login" id="login" placeholder=""><br>

    <div>
        <p id="p">Login successfully message</p>
    </div>
    <br><br>
    <br><br>

    <hr><br>
    <input type="email" name="email" id="emailSignup" placeholder="Email address" autocomplete="on"><br><br>
    <input type="password" name="password" id="passswordSignup"><br><br>
    <input type="password" name="password" id="comfirmPpassswordSignup"><br><br>
    <input type="button" value="Sign up" id="signup" placeholder="">
    <div>
        <p>Sign up successfully message</p>
    </div>
    <br><br>
    <hr><br>
    <input type="button" value="save question" id="btnSave" placeholder="">
    <input type="button" value="display question" id="display" placeholder="">
    <br><br>

    <div id="data">

    </div>


</body>

<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { ref, set, get, getDatabase, update, remove, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyA4kTjBxaAcmsz5QutEWu5QD_Vh89cpYJI",
        authDomain: "flutter-firebase-b11a3.firebaseapp.com",
        databaseURL: "https://flutter-firebase-b11a3-default-rtdb.firebaseio.com",
        projectId: "flutter-firebase-b11a3",
        storageBucket: "flutter-firebase-b11a3.appspot.com",
        messagingSenderId: "63657748609",
        appId: "1:63657748609:web:6f9931fb36974edb73c580",
        measurementId: "G-Q47YJESETB"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);

    let emailL = document.getElementById("emailLogin")
    let passswordLoginL = document.getElementById("passswordLogin")
    let signupBtnL = document.getElementById("login");

    let emailS = document.getElementById("emailSignup")
    let passswordS = document.getElementById("passswordSignup")
    let signupBtnS = document.getElementById("signup");

    let btnSave = document.getElementById("btnSave")
    let btnDisplay = document.getElementById("display")


    const auth = getAuth();

    function signup() {
        createUserWithEmailAndPassword(auth, emailS.value, passswordS.value)
            .then((userCredential) => {
                // Signed in 
                const user = userCredential.user;
                document.getElementById("p").innerHTML = user;
                alert("account created  succefully\n " + user.username);
                // ...
            })
            .catch((error) => {
                const errorCode = error.code;
                const errorMessage = error.message;
                alert(errorMessage);
                // ..
            });
    }

    function signin() {
        signInWithEmailAndPassword(auth, emailL.value, passswordLoginL.value)
            .then((userCredential) => {
                // Signed in 
                const user = userCredential.user;
                document.getElementById("p").innerHTML = user.uid + "<br>" + auth.currentUser.uid;
                //alert(user.email + "\n" + user.username + "\n" + auth);
            })
            .catch((error) => {
                const errorCode = error.code;
                const errorMessage = error.message;
                alert(errorMessage + "---><-----" + errorCode);
            });
    }

    signupBtnS.addEventListener('click', signup);
    signupBtnL.addEventListener('click', signin);


    function writeUserData() {
        const question = {
            question: "Inside which HTML element do we put the JavaScript??",
            choix1: "<script>",
            choix2: "<javascript>",
            choix3: "<js>",
            choix4: "<scripting>",
            reponse: 1,
            auteur: "Paul Dest"
        };
        /*const db = getDatabase().child('questions');
        db.ref().child(auth.currentUser.uid).push(question).then(data => {
            alert("data saved successfully");
        }).catch((error) => {
                const errorCode = error.code;
                const errorMessage = error.message;
                alert(errorMessage);
            });;*/
        const db = getDatabase()
        set(ref(db, "questions/" + auth.currentUser.uid + "/" + Date.now().toString()), {
            question: question.question,
            choix1: question.choix1,
            choix2: question.choix2,
            choix3: question.choix3,
            choix4: question.choix4,
            reponse: question.reponse,
            auteur: question.auteur
        }).then(data => {
            alert("data saved successfully");
        }).catch((error) => {
            const errorCode = error.code;
            const errorMessage = error.message;
            alert(errorMessage + "--->" + errorCode);
            1673583384611
        });
    }



    btnSave.addEventListener('click', writeUserData);
    function read() {
        const db = getDatabase();
        const starCountRef = ref(db, 'questions/' + auth.currentUser.uid);
        onValue(starCountRef, (snapshot) => {
            const data = snapshot.val();
            //console.log(snapshot.key, snapshot.val());
            document.getElementById('data').innerHTML = snapshotToArray(snapshot)[0].auteur;
            console.log(snapshotToArray(snapshot));
        });
    }
    function snapshotToArray(snapshot) {
        var returnArr = [];

        snapshot.forEach(function (childSnapshot) {
            var item = childSnapshot.val();
            item.key = childSnapshot.key;
            returnArr.push(item);
        });
        
        return returnArr;
    };

    btnDisplay.addEventListener('click', read);


</script>

</html>